<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­ç±³å¡ç‰Œç·¨è¼¯å™¨ v3.1 (è¦–çª—èˆ‡è£åˆ‡æœ€çµ‚ä¿®æ­£)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+And+White+Picture&family=Cinzel:wght@700&family=Creepster&family=Dela+Gothic+One&family=DotGothic16&family=Hachi+Maru+Pop&family=Kaisei+Tokumin:wght@700&family=Klee+One&family=Ma+Shan+Zheng&family=Mochiy+Pop+P+One&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@400;700&family=Orbitron:wght@700&family=Potta+One&family=RocknRoll+One&family=Yusei+Magic&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">

    <style>
        /* 1. å…¨å±€ä½ˆå±€ï¼šç¢ºä¿ä¸å‡ºç¾æ»¾å‹•æ¢ */
        body { 
            font-family: "Microsoft JhengHei", "FangSong", sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            display: flex; 
            gap: 20px; 
            padding: 20px; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            box-sizing: border-box; 
            margin: 0;
        }

        /* å·¦å´æ§åˆ¶å€ */
        .controls { 
            background: #2d2d2d; 
            padding: 20px; 
            padding-bottom: 100px; 
            border-radius: 10px; 
            width: 400px; 
            min-width: 350px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            overflow-y: auto; 
            height: 100%; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); 
            flex-shrink: 0; 
        }
        .controls::-webkit-scrollbar { width: 8px; }
        .controls::-webkit-scrollbar-track { background: #222; border-radius: 4px; }
        .controls::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        /* æ¨™é¡Œèˆ‡æ¨™ç±¤æ¨£å¼ */
        h3 { border-bottom: 2px solid #5E2C96; padding-bottom: 5px; margin: 0 0 10px 0; color: #ffd700; font-size: 1.1em; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { font-size: 0.7em; background: #333; padding: 2px 6px; border-radius: 4px; color: #555; border: 1px solid #555; }
        .status-badge.ready { color: #0f0; border-color: #0f0; background: #224422; }
        .flex-label { color: #ccc; font-size: 0.9em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .block-label { color: #ccc; font-size: 0.9em; font-weight: bold; display: block; margin-top: 10px; margin-bottom: 4px; }
        
        /* è¼¸å…¥å…ƒä»¶æ¨£å¼ */
        input[type="text"], select, textarea { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        .layer-card { background: #3a3a3a; border-radius: 8px; border-left: 5px solid #555; overflow: hidden; position: relative; flex-shrink: 0; }
        .layer-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #333; }
        .layer-body { padding: 10px; }
        .file-upload-label { display: inline-block; padding: 10px; background: #442222; color: #ffaaaa; border-radius: 4px; cursor: pointer; font-size: 0.9em; width: 100%; text-align: center; border: 1px solid #884444; box-sizing: border-box;}
        .file-upload-label:hover { background: #553333; color: #fff; }
        input[type="file"] { display: none; }
        .color-row { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px; border-radius: 5px; margin-top: 0; }
        input[type="color"] { border: none; width: 40px; height: 30px; cursor: pointer; background: none; padding: 0; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #0f0; }
        input[type="range"] { width: 100%; cursor: pointer; margin: 5px 0 10px 0; accent-color: #5E2C96; }
        input[type="number"] { background: #111; color: #0f0; border: 1px solid #444; border-radius: 4px; width: 60px; padding: 4px; text-align: right; font-family: monospace; }
        
        details { background: #222; border: 1px solid #444; border-radius: 5px; padding: 5px; margin-top: 10px; }
        summary { cursor: pointer; color: #ffd700; font-weight: bold; padding: 5px; outline: none; list-style: none; }
        summary::-webkit-details-marker { display: none; } 
        summary:after { content: " â–¼"; font-size: 0.8em; }
        details[open] summary:after { content: " â–²"; }
        .details-content { padding: 10px; border-top: 1px solid #444; margin-top: 5px; }

        /* 2. å³å´é è¦½å€å¡Šä¿®æ­£ */
        .preview-area { 
            flex: 1; 
            background: #000; 
            border-radius: 10px; 
            padding: 10px; /* é€™è£¡çš„ Padding æœƒä¿è­·å¡ç‰‡ä¸è²¼é‚Š */
            border: 1px solid #444; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            height: 100%; /* å¡«æ»¿çˆ¶å®¹å™¨é«˜åº¦ */
            min-width: 0; 
        }
        
        /* 3. Canvas ä¿®æ­£ï¼šå›æ­¸ä½¿ç”¨ %ï¼Œé€™æœƒè®“å®ƒä¹–ä¹–å¾…åœ¨é»‘è‰²æ¡†æ¡†å…§ */
        canvas { 
            background: #fff; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8); 
            border: 2px solid #333; 
            
            /* æ”¹å› 100%ï¼Œé€™ä»£è¡¨ã€Œä½”æ»¿é»‘è‰²æ¡†æ¡†çš„é«˜åº¦ï¼Œä½†çµ•ä¸è¶…å‡ºã€ */
            max-width: 100%; 
            max-height: 100%; 
            
            width: auto; 
            height: auto; 
            object-fit: contain; 
        }
        
        button { background: #5E2C96; color: #fff; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; width: 100%; transition: 0.2s; margin-top: 10px;}
    </style>
</head>
<body>

    <div class="controls">
        <h3>
            æ­ç±³å¡ç‰Œç·¨è¼¯å™¨
            <span id="globalStatus" class="status-badge">è¼‰å…¥ä¸­...</span>
        </h3>
        
        <div class="layer-card" style="border-color: #E60012;">
            <div class="layer-header"><span>1. é‚Šæ¡†/é®ç½©è‰²</span></div>
            <div class="layer-body">
                <div class="color-row">
                    <input type="checkbox" id="tintEnableB" checked onchange="drawCard()">
                    <span style="flex:1">å•Ÿç”¨æŸ“è‰²</span>
                    <input type="color" id="tintColorB" value="#E60012" oninput="drawCard()">
                </div>
            </div>
        </div>

        <div class="layer-card" style="border-color: #F39800;">
            <div class="layer-header"><span>2. ç´‹ç†è‰²</span></div>
            <div class="layer-body">
                <div class="color-row">
                    <input type="checkbox" id="tintEnableC" checked onchange="drawCard()">
                    <span style="flex:1">å•Ÿç”¨æŸ“è‰²</span>
                    <input type="color" id="tintColorC" value="#F39800" oninput="drawCard()">
                </div>
            </div>
        </div>

        <div class="layer-card" style="border-color: #FFD700;">
            <div class="layer-header"><span>3. é ‚å±¤è£é£¾è‰²</span></div>
            <div class="layer-body">
                <div class="color-row">
                    <input type="checkbox" id="tintEnableD" checked onchange="drawCard()">
                    <span style="flex:1">å•Ÿç”¨æŸ“è‰²</span>
                    <input type="color" id="tintColorD" value="#FFD700" oninput="drawCard()">
                </div>
            </div>
        </div>

        <div class="layer-card" style="border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.2);">
            <div class="layer-header" style="background:#444;"><span>4. å¡é¢ç‰¹æ•ˆ</span></div>
            <div class="layer-body">
                <div class="block-label">é¸æ“‡ç‰¹æ•ˆ</div>
                <select id="effectSelect" onchange="loadEffect()" style="width:100%"></select>

                <div class="flex-label" style="margin-top:10px;">æ··åˆæ¨¡å¼
                    <select id="effectBlend" onchange="drawCard()" style="width:50%">
                        <option value="overlay">ç–ŠåŠ </option>
                        <option value="screen">æ¿¾è‰²</option>
                        <option value="color-dodge">åŠ äº®</option>
                        <option value="multiply">è‰²å½©å¢å€¼</option>
                        <option value="source-over">æ­£å¸¸è¦†è“‹</option>
                    </select>
                </div>
                
                <div class="flex-label" style="margin-top:10px;">
                    é€æ˜åº¦ 
                    <input type="range" id="effectOpacity" min="0" max="1" step="0.1" value="0.5" oninput="sync(this.value, 'n_effectOpacity')" style="width:40%">
                    <input type="number" id="n_effectOpacity" value="0.5" step="0.1" min="0" max="1" oninput="sync(this.value, 'effectOpacity')">
                </div>
            </div>
        </div>

        <div class="layer-card" style="border-color: #fff; margin-top:15px;">
            <div class="layer-header">å…§å®¹è¨­å®š</div>
            <div class="layer-body">
                <label class="file-upload-label">
                    ğŸ“¸ ä¸Šå‚³ä¸»è§’ç…§ç‰‡ (å¿…å¡«)
                    <input type="file" id="uploadUserImg" accept="image/*">
                </label>
                
                <div class="flex-label" style="margin-top:10px;">å­—é«”
                    <select id="fontSelect" onchange="drawCard()" style="width:60%">
                        <optgroup label="ç¶“å…¸å¸¸ç”¨">
                            <option value="Microsoft JhengHei">å¾®è»Ÿæ­£é»‘é«”</option>
                            <option value="DFKai-SB, BiaoKai">æ¨™æ¥·é«”</option>
                            <option value="'Noto Sans TC'">æ€æºé»‘é«” (æ¨™æº–)</option>
                            <option value="'Noto Serif TC'">æ€æºå®‹é«” (æ¨™æº–)</option>
                        </optgroup>
                        
                        <optgroup label="âœ¨ æ–°å¢ï¼šç‰¹è‰²ä¸­æ–‡/æ¼¢å­—">
                            <option value="'Dela Gothic One'">æ¥µç²—å“¥ç‰¹ (é­„åŠ›æ¨™é¡Œ)</option>
                            <option value="'Kaisei Tokumin'">ç‰¹å…‹æ˜æœ (å¥‡å¹»é‹’åˆ©)</option>
                            <option value="'Potta One'">æ—¥ç³»æ¿ƒç­† (æ¯›ç­†æ„Ÿ)</option>
                            <option value="'Mochiy Pop P One'">åœ“æ½¤POP (å¯æ„›)</option>
                            <option value="'Zhi Mang Xing'">èŠè½è¡Œæ›¸ (ç‹‚é‡)</option>
                            <option value="'Ma Shan Zheng'">é¦¬å–„æ”¿æ¯›ç­†</option>
                        </optgroup>

                        <optgroup label="æ‰‹å¯«/å¯æ„›é¢¨æ ¼">
                            <option value="'Klee One'">å…‹åˆ©é«” (ç¡¬ç­†æ‰‹å¯«)</option>
                            <option value="'Yusei Magic'">æ²¹æ€§ç­†é«”</option>
                            <option value="'Hachi Maru Pop'">æ³¢æ³¢é«”</option>
                            <option value="'RocknRoll One'">æ–æ»¾é«”</option>
                            <option value="'DotGothic16'">é»é™£åƒç´  (å¾©å¤)</option>
                        </optgroup>

                        <optgroup label="ğŸŒ ç‰¹æ®Šèªè¨€é¢¨æ ¼ (è‹±/éŸ“)">
                            <option value="'Cinzel'">Cinzel (æ­é¢¨ç¾…é¦¬çŸ³åˆ»)</option>
                            <option value="'Orbitron'">Orbitron (ç§‘å¹»æ•¸å­—)</option>
                            <option value="'Creepster'">Creepster (ææ€–é©šæ‚š)</option>
                            <option value="'Black And White Picture'">Black&White (éŸ“ç³»ç²—åˆ·)</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="flex-label" style="margin-top:5px; background:#222; padding:5px; border-radius:4px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label style="display:flex; align-items:center; gap:3px; cursor:pointer;">
                            <input type="checkbox" id="fontBold" checked onchange="drawCard()"> <b>ç²—</b>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; cursor:pointer;">
                            <input type="checkbox" id="fontItalic" onchange="drawCard()"> <i>æ–œ</i>
                        </label>
                    </div>
                    <div style="flex:1; display:flex; align-items:center; justify-content:flex-end; gap:5px;">
                        <span style="font-size:0.8em;">å­—è·</span>
                        <input type="range" id="fontSpacing" min="-10" max="30" value="0" step="1" oninput="sync(this.value, 'n_fontSpacing')" style="width:40px;">
                        <input type="number" id="n_fontSpacing" value="0" step="1" oninput="sync(this.value, 'fontSpacing')" style="width:50px;">
                    </div>
                </div>

                <div class="flex-label" style="margin-top:10px;">åç¨± <input type="text" id="cardName" value="å¡ç‰Œåç¨±" oninput="drawCard()" style="width:70%"></div>
                <div class="flex-label">ç¨®æ— <input type="text" id="cardRace" value="ç¨®æ—åç¨±" oninput="drawCard()" style="width:70%"></div>
                
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div style="flex:1">
                         <div class="block-label">ç­‰ç´š</div>
                         <select id="cardRankSelect" onchange="loadRank()" style="width:100%">
                            <option value="rank_1.png">Lv.1</option>
                            <option value="rank_2.png">Lv.2</option>
                            <option value="rank_3.png" selected>Lv.3</option>
                            <option value="rank_4.png">Lv.4</option>
                            <option value="rank_5.png">Lv.5</option>
                            <option value="rank_6.png">Lv.6</option>
                            <option value="rank_6_pumpkin.png">ğŸƒ Lv.6 å—ç“œ</option>
                        </select>
                        <div class="color-row" style="padding:2px; margin-top:2px; border:1px solid #555;">
                             <input type="checkbox" id="tintEnableRank" checked onchange="drawCard()">
                             <span style="font-size:0.8em; flex:1;">åœ–ç¤ºæŸ“è‰²</span>
                             <input type="color" id="tintColorRank" value="#000000" oninput="drawCard()">
                        </div>
                    </div>
                </div>

                <div class="block-label">èªªæ˜æ–‡</div>
                <textarea id="cardDesc" rows="3" oninput="drawCard()">è¼¸å…¥å¡ç‰Œèªªæ˜æ–‡å­—...</textarea>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1; display:flex; align-items:center; justify-content:space-between; background:#222; padding:5px; border-radius:4px;">
                        <span style="font-size:0.9em; color:#ccc; font-weight:bold;">æ–‡å­—è‰²</span>
                        <input type="color" id="textColor" value="#000000" oninput="drawCard()" style="height:30px; width:40px; border:none; cursor:pointer;">
                    </div>
                    <div style="flex:1; display:flex; align-items:center; justify-content:space-between; background:#222; padding:5px; border-radius:4px;">
                        <span style="font-size:0.9em; color:#ccc; font-weight:bold;">åº•ç´™è‰²</span>
                        <input type="color" id="paperColor" value="#FFFBE6" oninput="drawCard()" style="height:30px; width:40px; border:none; cursor:pointer;">
                    </div>
                </div>
            </div>
        </div>
        
        <details>
            <summary>ğŸ“ é€²éšï¼šä½ç½®èˆ‡å¤§å°èª¿æ•´ (ç²¾æº–ç‰ˆ)</summary>
            <div class="details-content">
                
                <h4 style="margin-top:0; color:#0f0;">ä¸»è§’ç…§ç‰‡èª¿æ•´ (è‡ªå‹•å¡«æ»¿ç•«æ¡†)</h4>
                <div class="flex-label">
                    ç¸®æ”¾ 
                    <input type="range" id="userScale" min="0.01" max="5.0" step="0.01" value="1.0" oninput="sync(this.value, 'n_userScale')" style="width:50%"> 
                    <input type="number" id="n_userScale" value="1.0" step="0.01" oninput="sync(this.value, 'userScale')">
                </div>
                <div style="display:flex; gap:5px;">
                    <div class="flex-label" style="flex:1">
                        X <input type="range" id="userX" min="-300" max="900" value="325" oninput="sync(this.value, 'n_userX')"> 
                        <input type="number" id="n_userX" value="325" oninput="sync(this.value, 'userX')">
                    </div>
                    <div class="flex-label" style="flex:1">
                        Y <input type="range" id="userY" min="-300" max="1200" value="354" oninput="sync(this.value, 'n_userY')"> 
                        <input type="number" id="n_userY" value="354" oninput="sync(this.value, 'userY')">
                    </div>
                </div>

                <h4 style="margin-top:15px; color:#aaa;">æ¨™é¡Œä½ç½®</h4>
                <div style="display:flex; gap:5px;">
                    <div class="flex-label" style="flex:1">
                        X <input type="range" id="titleX" min="0" max="650" value="325" oninput="sync(this.value, 'n_titleX')">
                        <input type="number" id="n_titleX" value="325" oninput="sync(this.value, 'titleX')">
                    </div>
                    <div class="flex-label" style="flex:1">
                        Y <input type="range" id="titleY" min="0" max="200" value="56" oninput="sync(this.value, 'n_titleY')">
                        <input type="number" id="n_titleY" value="56" oninput="sync(this.value, 'titleY')">
                    </div>
                </div>
                <div class="flex-label">å¤§å° <input type="range" id="titleSize" min="20" max="80" value="42" oninput="sync(this.value, 'n_titleSize')" style="width:50%"><input type="number" id="n_titleSize" value="42" oninput="sync(this.value, 'titleSize')"></div>
                
                <h4 style="margin-top:10px; color:#aaa;">ç¨®æ—ä½ç½®</h4>
                <div style="display:flex; gap:5px;">
                    <div class="flex-label" style="flex:1">X <input type="range" id="raceX" min="0" max="650" value="177" oninput="sync(this.value, 'n_raceX')"><input type="number" id="n_raceX" value="177" oninput="sync(this.value, 'raceX')"></div>
                    <div class="flex-label" style="flex:1">
                        Y <input type="range" id="raceY" min="400" max="800" value="640" oninput="sync(this.value, 'n_raceY')">
                        <input type="number" id="n_raceY" value="640" oninput="sync(this.value, 'raceY')">
                    </div>
                </div>
                <div class="flex-label">å¤§å° <input type="range" id="raceSize" min="16" max="50" value="32" oninput="sync(this.value, 'n_raceSize')" style="width:50%"><input type="number" id="n_raceSize" value="32" oninput="sync(this.value, 'raceSize')"></div>

                <h4 style="margin-top:10px; color:#aaa;">èªªæ˜æ–‡ä½ç½®</h4>
                <div style="display:flex; gap:5px;">
                    <div class="flex-label" style="flex:1">X <input type="range" id="descX" min="0" max="200" value="85" oninput="sync(this.value, 'n_descX')"><input type="number" id="n_descX" value="85" oninput="sync(this.value, 'descX')"></div>
                    <div class="flex-label" style="flex:1">Y <input type="range" id="descY" min="500" max="900" value="700" oninput="sync(this.value, 'n_descY')"><input type="number" id="n_descY" value="700" oninput="sync(this.value, 'descY')"></div>
                </div>
                <div class="flex-label">å¯¬åº¦ <input type="range" id="descW" min="200" max="600" value="480" oninput="sync(this.value, 'n_descW')" style="width:50%"><input type="number" id="n_descW" value="480" oninput="sync(this.value, 'descW')"></div>
            </div>
        </details>

        <button onclick="downloadCard()">ä¸‹è¼‰å¡ç‰Œ</button>
    </div>

    <div class="preview-area">
        <canvas id="cardCanvas" width="650" height="900"></canvas>
    </div>

    <script>
        const effectList = [
            { name: "ç„¡ç‰¹æ•ˆ", file: "effect_none.png" },
            { name: "ç‰¹æ•ˆ 1", file: "effect_1.png" },
            { name: "ç‰¹æ•ˆ 2", file: "effect_2.png" },
            { name: "ç‰¹æ•ˆ 3", file: "effect_3.png" },
        ];

        const canvas = document.getElementById('cardCanvas');
        const ctx = canvas.getContext('2d');
        const CW = 650, CH = 900;
        canvas.width = CW; canvas.height = CH;

        const assets = {
            base: { src: 'frame_base.png', img: new Image(), loaded: false },
            mask: { src: 'layer_b.png',    img: new Image(), loaded: false },
            texture: { src: 'layer_c.png', img: new Image(), loaded: false },
            deco: { src: 'layer_d.png',    img: new Image(), loaded: false },
            effect: { src: effectList[0].file, img: new Image(), loaded: false },
            rank: { src: 'rank_3.png',     img: new Image(), loaded: false }, 
            user: { src: null,             img: new Image(), loaded: false }
        };

        function initEffectMenu() {
            const select = document.getElementById('effectSelect');
            select.innerHTML = "";
            effectList.forEach(ef => {
                const opt = document.createElement('option');
                opt.value = ef.file;
                opt.textContent = ef.name;
                select.appendChild(opt);
            });
        }

        function preloadAssets() {
            initEffectMenu();
            let loadedCount = 0;
            const keys = ['base', 'mask', 'texture', 'deco', 'rank', 'effect'];
            keys.forEach(key => {
                if (assets[key].src) {
                    assets[key].img.crossOrigin = "Anonymous";
                    assets[key].img.src = assets[key].src;
                    assets[key].img.onload = () => {
                        assets[key].loaded = true;
                        loadedCount++;
                        if(loadedCount >= keys.length) {
                            document.getElementById('globalStatus').textContent = "ç³»çµ±å°±ç·’";
                            document.getElementById('globalStatus').classList.add('ready');
                            drawCard();
                        }
                    };
                    assets[key].img.onerror = () => { 
                        console.error(`æ‰¾ä¸åˆ°åœ–ç‰‡: ${assets[key].src}`);
                        if(key === 'effect') assets[key].loaded = false; 
                        loadedCount++; 
                        if(loadedCount >= keys.length) drawCard();
                    };
                }
            });
        }

        document.getElementById('uploadUserImg').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                assets.user.img.src = ev.target.result;
                assets.user.img.onload = () => { 
                    assets.user.loaded = true; 
                    autoFitUserImage(); 
                };
            };
            reader.readAsDataURL(f);
        });

        function autoFitUserImage() {
            if(!assets.user.loaded) return;
            const imgW = assets.user.img.width;
            const imgH = assets.user.img.height;
            // 3. è‡ªå‹•å¡«æ»¿ç›®æ¨™å°ºå¯¸æ›´æ–° (519x469)
            const targetW = 519;
            const targetH = 469;
            const targetCenterX = 325;
            const targetCenterY = 354;

            const scale = Math.max(targetW / imgW, targetH / imgH);
            
            sync(scale.toFixed(2), 'n_userScale'); sync(scale.toFixed(2), 'userScale');
            sync(targetCenterX, 'n_userX');        sync(targetCenterX, 'userX');
            sync(targetCenterY, 'n_userY');        sync(targetCenterY, 'userY');
            
            drawCard();
        }

        function loadRank() {
            const val = document.getElementById('cardRankSelect').value;
            assets.rank.loaded = false;
            assets.rank.img.src = val; 
            assets.rank.img.onload = () => { assets.rank.loaded = true; drawCard(); };
        }
        
        function loadEffect() {
            const val = document.getElementById('effectSelect').value;
            assets.effect.loaded = false;
            assets.effect.img.src = val;
            assets.effect.img.onload = () => { assets.effect.loaded = true; drawCard(); };
            assets.effect.img.onerror = () => { assets.effect.loaded = false; drawCard(); };
        }

        function drawTintedImage(targetCtx, img, color, isEnabled, x=0, y=0, w=CW, h=CH) {
            if (!isEnabled) { targetCtx.drawImage(img, x, y, w, h); return; }
            const tCv = document.createElement('canvas'); tCv.width = w; tCv.height = h; const tCtx = tCv.getContext('2d');
            tCtx.drawImage(img, 0, 0, w, h);
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.fillStyle = color;
            tCtx.fillRect(0, 0, w, h);
            targetCtx.drawImage(tCv, x, y, w, h);
        }

        function sync(val, targetId) {
            const el = document.getElementById(targetId);
            if(el) {
                el.value = val;
                drawCard(); 
            }
        }

        function drawCard() {
            ctx.clearRect(0, 0, CW, CH);
            ctx.fillStyle = document.getElementById('paperColor').value; 
            ctx.fillRect(0, 0, CW, CH);

            const userScale = parseFloat(document.getElementById('userScale').value);
            const userX = parseFloat(document.getElementById('userX').value);
            const userY = parseFloat(document.getElementById('userY').value);
            
            const titleX = parseInt(document.getElementById('titleX').value);
            const titleY = parseInt(document.getElementById('titleY').value);
            const titleSize = parseInt(document.getElementById('titleSize').value);
            
            const raceX = parseInt(document.getElementById('raceX').value);
            const raceY = parseInt(document.getElementById('raceY').value);
            const raceSize = parseInt(document.getElementById('raceSize').value);
            
            const descX = parseInt(document.getElementById('descX').value);
            const descY = parseInt(document.getElementById('descY').value);
            const descW = parseInt(document.getElementById('descW').value);

            const fontSpacing = document.getElementById('fontSpacing').value;

            // ç¹ªè£½ä¸»è§’ç…§ç‰‡ (Clipping Mask - ä¿®æ­£å°ºå¯¸ 519x469)
            if (assets.user.loaded) {
                ctx.save();
                ctx.beginPath();
                // åº§æ¨™ç²¾ç®—ï¼šä¸­å¿ƒ(325, 354)ï¼Œå¯¬519ï¼Œé«˜469
                // X = 325 - 259.5 = 65.5
                // Y = 354 - 234.5 = 119.5
                ctx.rect(65.5, 119.5, 519, 469); 
                ctx.clip(); 

                const w = assets.user.img.width * userScale; 
                const h = assets.user.img.height * userScale;
                ctx.drawImage(assets.user.img, userX - w/2, userY - h/2, w, h);
                
                ctx.restore(); 
            } else {
                ctx.fillStyle = "#333"; ctx.font = "20px sans-serif"; ctx.textAlign = "center"; 
                ctx.fillText("è«‹ä¸Šå‚³ä¸»è§’ç…§ç‰‡", CW/2, 354);
            }

            if (assets.mask.loaded) drawTintedImage(ctx, assets.mask.img, document.getElementById('tintColorB').value, document.getElementById('tintEnableB').checked);
            if (assets.texture.loaded) drawTintedImage(ctx, assets.texture.img, document.getElementById('tintColorC').value, document.getElementById('tintEnableC').checked);
            if (assets.deco.loaded) drawTintedImage(ctx, assets.deco.img, document.getElementById('tintColorD').value, document.getElementById('tintEnableD').checked);
            if (assets.base.loaded) { ctx.save(); ctx.globalCompositeOperation = 'multiply'; ctx.drawImage(assets.base.img, 0, 0, CW, CH); ctx.restore(); }

            if (assets.effect.loaded) {
                ctx.save();
                ctx.globalAlpha = document.getElementById('effectOpacity').value;
                ctx.globalCompositeOperation = document.getElementById('effectBlend').value;
                ctx.drawImage(assets.effect.img, 0, 0, CW, CH);
                ctx.restore();
            }

            if (ctx.letterSpacing !== undefined) { ctx.letterSpacing = fontSpacing + "px"; }
            drawText(titleX, titleY, titleSize, raceX, raceY, raceSize, descX, descY, descW);
        }

        function drawText(tx, ty, ts, rx, ry, rs, dx, dy, dw) {
            const name = document.getElementById('cardName').value;
            const race = document.getElementById('cardRace').value;
            const desc = document.getElementById('cardDesc').value;
            const textColor = document.getElementById('textColor').value;
            const fontChoice = document.getElementById('fontSelect').value;
            
            const isBold = document.getElementById('fontBold').checked;
            const isItalic = document.getElementById('fontItalic').checked;
            let fontStyle = "";
            if(isBold) fontStyle += "bold ";
            if(isItalic) fontStyle += "italic ";

            const font = `${fontStyle} ${fontChoice}, "Microsoft JhengHei", sans-serif`;

            ctx.fillStyle = textColor;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            ctx.font = `${fontStyle} ${ts}px ${fontChoice}, "Microsoft JhengHei", sans-serif`;
            ctx.fillText(name, tx, ty);

            ctx.font = `${fontStyle} ${rs}px ${fontChoice}, "Microsoft JhengHei", sans-serif`;
            ctx.fillText(race, rx, ry);

            if(assets.rank.loaded) {
                const tintRank = document.getElementById('tintEnableRank').checked;
                const colorRank = document.getElementById('tintColorRank').value;
                drawTintedImage(ctx, assets.rank.img, colorRank, tintRank, 0, 0, CW, CH);
            }
            
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            ctx.font = `${fontStyle} 26px ${fontChoice}, "Microsoft JhengHei", sans-serif`;
            wrapText(ctx, desc, dx, dy, dw, 38);
        }

        function wrapText(ctx, text, x, y, maxW, lineH) {
            let words = text.split(''); let line = '';
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n];
                if (ctx.measureText(testLine).width > maxW && n > 0) { ctx.fillText(line, x, y); line = words[n]; y += lineH; } 
                else { line = testLine; }
            } ctx.fillText(line, x, y);
        }
        
        function downloadCard() {
            const a = document.createElement('a');
            a.download = document.getElementById('cardName').value + ".png";
            a.href = canvas.toDataURL("image/png");
            a.click();
        }

        window.addEventListener('load', preloadAssets);
    </script>
</body>
</html>
