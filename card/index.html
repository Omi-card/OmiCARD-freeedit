<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­ç±³å¡ç‰Œç·¨è¼¯å™¨</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Hachi+Maru+Pop&family=Klee+One&family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=RocknRoll+One&family=Yusei+Magic&family=Zhi+Mang+Xing&family=Dela+Gothic+One&family=Kaisei+Tokumin:wght@700&family=Black+Han+Sans&family=Do+Hyeon&family=Nanum+Pen+Script&family=UnifrakturMaguntia&family=Orbitron:wght@700&family=Bangers&family=Cinzel:wght@700&family=Permanent+Marker&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: "Noto Sans TC", sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            display: flex; 
            gap: 20px; 
            padding: 15px; 
            height: 100vh; 
            margin: 0;
            overflow: hidden; 
            box-sizing: border-box; 
            align-items: flex-start; 
        }
        
        .controls { 
            background: #2d2d2d; 
            padding: 20px; 
            padding-bottom: 120px; 
            border-radius: 10px; 
            width: 420px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            overflow-y: auto; 
            height: 100%; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.5); 
            flex-shrink: 0; 
        }

        .controls::-webkit-scrollbar { width: 8px; }
        .controls::-webkit-scrollbar-track { background: #222; }
        .controls::-webkit-scrollbar-thumb { background: #5E2C96; border-radius: 4px; }
        
        h3 { border-bottom: 2px solid #5E2C96; padding-bottom: 8px; margin: 0 0 5px 0; color: #ffd700; display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; }
        .status-badge { font-size: 0.7em; background: #333; padding: 2px 6px; border-radius: 4px; color: #555; border: 1px solid #555; }
        .status-badge.ready { color: #0f0; border-color: #0f0; background: #224422; }

        .flex-label { color: #ccc; font-size: 0.85em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .block-label { color: #ccc; font-size: 0.85em; font-weight: bold; display: block; margin-top: 8px; margin-bottom: 4px; }
        input[type="text"], select, textarea { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        
        .layer-card { background: #3a3a3a; border-radius: 8px; border-left: 5px solid #555; overflow: hidden; flex-shrink: 0; }
        .layer-header { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #333; font-size: 0.9em; font-weight: bold; }
        .layer-body { padding: 10px 12px; }
        
        .color-row { display: flex; align-items: center; gap: 10px; background: #222; padding: 6px 10px; border-radius: 5px; }
        input[type="color"] { border: none; width: 35px; height: 25px; cursor: pointer; background: none; padding: 0; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #0f0; }
        
        details { background: #222; border: 1px solid #444; border-radius: 5px; padding: 5px; margin-top: 5px; }
        summary { cursor: pointer; color: #ffd700; font-size: 0.9em; font-weight: bold; padding: 5px; }
        
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #5E2C96; margin: 5px 0; }
        input[type="number"] { background: #111; color: #0f0; border: 1px solid #444; border-radius: 4px; width: 55px; padding: 3px; text-align: right; font-family: monospace; }
        
        .preview-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; border-radius: 10px; height: 100%; border: 1px solid #444; }
        canvas { background: #fff; box-shadow: 0 0 40px rgba(0,0,0,0.9); border: 2px solid #333; max-height: 95%; max-width: 95%; object-fit: contain; }
        
        .file-upload-label { display: inline-block; padding: 10px; background: #442222; color: #ffaaaa; border-radius: 4px; cursor: pointer; font-size: 0.9em; width: 100%; text-align: center; border: 1px solid #884444; box-sizing: border-box; margin-bottom: 5px;}
        button { background: #5E2C96; color: #fff; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-weight: bold; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>æ­ç±³å¡ç‰Œç·¨è¼¯å™¨ <span id="globalStatus" class="status-badge">è¼‰å…¥ä¸­...</span></h3>
        
        <div class="layer-card" style="border-color: #ffd700;"><div class="layer-body"><div class="color-row"><input type="checkbox" id="tintEnableB" checked onchange="drawCard()"><span style="flex:1;font-size:0.9em;">1. é‚Šæ¡†æŸ“è‰²</span><input type="color" id="tintColorB" value="#ff0000" oninput="drawCard()"></div></div></div>
        <div class="layer-card" style="border-color: #00ffff;"><div class="layer-body"><div class="color-row"><input type="checkbox" id="tintEnableC" checked onchange="drawCard()"><span style="flex:1;font-size:0.9em;">2. ç´‹ç†æŸ“è‰²</span><input type="color" id="tintColorC" value="#ffff00" oninput="drawCard()"></div></div></div>
        <div class="layer-card" style="border-color: #ff55ff;"><div class="layer-body"><div class="color-row"><input type="checkbox" id="tintEnableD" checked onchange="drawCard()"><span style="flex:1;font-size:0.9em;">3. è£é£¾æŸ“è‰²</span><input type="color" id="tintColorD" value="#00ff00" oninput="drawCard()"></div></div></div>

        <div class="layer-card" style="border-color: #fff;"><div class="layer-header">4. å¡é¢ç‰¹æ•ˆ</div><div class="layer-body">
            <select id="effectSelect" onchange="loadEffect()" style="margin-bottom:8px;"></select>
            <div class="flex-label">æ¨¡å¼ <select id="effectBlend" onchange="drawCard()" style="width:60%"><option value="overlay">ç–ŠåŠ </option><option value="screen">æ¿¾è‰²</option><option value="color-dodge">åŠ äº®</option><option value="multiply">å¢å€¼</option><option value="source-over">æ­£å¸¸</option></select></div>
            <div class="flex-label">é€æ˜ <input type="range" id="effectOpacity" min="0" max="1" step="0.1" value="0.5" oninput="sync(this.value, 'n_effectOpacity')" style="width:50%"><input type="number" id="n_effectOpacity" value="0.5" step="0.1" min="0" max="1" oninput="sync(this.value, 'effectOpacity')"></div>
        </div></div>

        <div class="layer-card">
            <div class="layer-header">å…§å®¹èˆ‡å­—é«”</div>
            <div class="layer-body">
                <label class="file-upload-label">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" id="uploadUserImg" accept="image/*" style="display:none"></label>
                
                <select id="fontSelect" onchange="drawCard()">
                    <optgroup label="ä¸­æ—¥æ–‡å…¼å®¹"><option value="'Noto Sans TC'">æ¨™æº–é»‘é«”</option><option value="'Noto Serif TC'">ç¶“å…¸å®‹é«”</option><option value="'Dela Gothic One'">è¶…ç²—åƒç´ </option><option value="'Zhi Mang Xing'">ç‹‚æ”¾æ›¸æ³•</option><option value="'Klee One'">æ¸…çˆ½æ‰‹å¯«</option><option value="'DotGothic16'">8-bit é»é™£</option></optgroup>
                    <optgroup label="éŸ“æ–‡"><option value="'Black Han Sans'">éŸ“èªç²—é«”</option><option value="'Nanum Pen Script'">æ¸…æ–°ç­†è·¡</option></optgroup>
                    <optgroup label="è‹±æ–‡/æ‹‰ä¸"><option value="'UnifrakturMaguntia'">ä¸­å¤æ­Œå¾·</option><option value="'Cinzel'">ç¾…é¦¬çŸ³åˆ»</option><option value="'Orbitron'">æœªä¾†ç§‘å¹»</option></optgroup>
                </select>

                <div class="flex-label" style="margin-top:10px;">åç¨± <input type="text" id="cardName" value="å¡ç‰Œåç¨±" oninput="drawCard()" style="width:75%"></div>
                <div class="flex-label">ç¨®æ— <input type="text" id="cardRace" value="ç¨®æ—åç¨±" oninput="drawCard()" style="width:75%"></div>
                
                <div class="block-label">ç­‰ç´šèˆ‡é¡è‰²</div>
                <div style="display:flex; gap:5px;">
                    <select id="cardRankSelect" onchange="loadRank()" style="flex:1"><option value="rank_1.png">Lv.1</option><option value="rank_2.png">Lv.2</option><option value="rank_3.png" selected>Lv.3</option><option value="rank_4.png">Lv.4</option><option value="rank_5.png">Lv.5</option><option value="rank_6.png">Lv.6</option></select>
                    <input type="color" id="textColor" value="#000000" oninput="drawCard()" title="æ–‡å­—é¡è‰²">
                    <input type="color" id="paperColor" value="#FFFBE6" oninput="drawCard()" title="å¡ç‰‡åº•è‰²">
                </div>
                <textarea id="cardDesc" rows="2" oninput="drawCard()" style="margin-top:8px;">è¼¸å…¥æ•˜è¿°æ–‡å­—...</textarea>
            </div>
        </div>
        
        <details>
            <summary>ğŸ“ é€²éšï¼šä½ç½®èˆ‡ç¸®æ”¾ (ç²¾æº–æ§åˆ¶)</summary>
            <div class="layer-body" style="font-size:0.85em;">
                <div class="flex-label">ç…§ç‰‡ç¸®æ”¾ <input type="range" id="userScale" min="0.01" max="5.0" step="0.01" value="1.0" oninput="sync(this.value, 'n_userScale')"><input type="number" id="n_userScale" value="1.0" step="0.01" oninput="sync(this.value, 'userScale')"></div>
                <div class="flex-label">ç…§ç‰‡ X <input type="range" id="userX" min="-300" max="900" value="325" oninput="sync(this.value, 'n_userX')"><input type="number" id="n_userX" value="325" oninput="sync(this.value, 'userX')"></div>
                <div class="flex-label">ç…§ç‰‡ Y <input type="range" id="userY" min="-300" max="1200" value="354" oninput="sync(this.value, 'n_userY')"><input type="number" id="n_userY" value="354" oninput="sync(this.value, 'userY')"></div>
                <hr style="border:0; border-top:1px solid #444; margin:8px 0;">
                <div class="flex-label">æ¨™é¡Œ Y <input type="range" id="titleY" min="0" max="200" value="56" oninput="sync(this.value, 'n_titleY')"><input type="number" id="n_titleY" value="56" oninput="sync(this.value, 'titleY')"></div>
                <div class="flex-label">ç¨®æ— X <input type="range" id="raceX" min="0" max="650" value="177" oninput="sync(this.value, 'n_raceX')"><input type="number" id="n_raceX" value="177" oninput="sync(this.value, 'raceX')"></div>
                <div class="flex-label">ç¨®æ— Y <input type="range" id="raceY" min="400" max="800" value="640" oninput="sync(this.value, 'n_raceY')"><input type="number" id="n_raceY" value="640" oninput="sync(this.value, 'raceY')"></div>
            </div>
        </details>

        <button onclick="downloadCard()">ä¸‹è¼‰å¡ç‰Œåœ–ç‰‡</button>
    </div>

    <div class="preview-area">
        <canvas id="cardCanvas" width="650" height="900"></canvas>
    </div>

    <script>
        const effectList = [
            { name: "ç„¡ç‰¹æ•ˆ", file: "effect_none.png" },
            { name: "ç‰¹æ•ˆ 1 (é‡‘ç®”)", file: "effect_1.png" },
            { name: "ç‰¹æ•ˆ 2 (ç¢é‘½)", file: "effect_2.png" },
            { name: "ç‰¹æ•ˆ 3 (å…‰æšˆ)", file: "effect_3.png" }
        ];

        const canvas = document.getElementById('cardCanvas');
        const ctx = canvas.getContext('2d');
        const CW = 650, CH = 900;

        const assets = {
            base: { src: 'frame_base.png', img: new Image() },
            mask: { src: 'layer_b.png',    img: new Image() },
            texture: { src: 'layer_c.png', img: new Image() },
            deco: { src: 'layer_d.png',    img: new Image() },
            effect: { src: effectList[0].file, img: new Image() },
            rank: { src: 'rank_3.png',     img: new Image() }, 
            user: { src: null,             img: new Image(), loaded: false }
        };

        function initEffectMenu() {
            const select = document.getElementById('effectSelect');
            select.innerHTML = "";
            effectList.forEach(ef => {
                const opt = document.createElement('option');
                opt.value = ef.file; opt.textContent = ef.name;
                select.appendChild(opt);
            });
        }

        function preloadAssets() {
            initEffectMenu();
            let loadedCount = 0;
            const keys = ['base', 'mask', 'texture', 'deco', 'rank', 'effect'];
            keys.forEach(key => {
                assets[key].img.crossOrigin = "Anonymous";
                assets[key].img.src = assets[key].src;
                assets[key].img.onload = () => {
                    loadedCount++;
                    if(loadedCount >= keys.length) {
                        document.getElementById('globalStatus').textContent = "ç³»çµ±å°±ç·’";
                        document.getElementById('globalStatus').classList.add('ready');
                        drawCard();
                    }
                };
                assets[key].img.onerror = () => { if(key==='effect') loadedCount++; };
            });
        }

        document.getElementById('uploadUserImg').addEventListener('change', (e) => {
            const f = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                assets.user.img.src = ev.target.result;
                assets.user.img.onload = () => {
                    assets.user.loaded = true;
                    const s = Math.max(510 / assets.user.img.width, 460 / assets.user.img.height);
                    sync(s.toFixed(2), 'n_userScale'); sync(s.toFixed(2), 'userScale');
                    sync(325, 'n_userX'); sync(325, 'userX');
                    sync(354, 'n_userY'); sync(354, 'userY');
                };
            };
            reader.readAsDataURL(f);
        });

        function loadRank() { assets.rank.img.src = document.getElementById('cardRankSelect').value; assets.rank.img.onload = drawCard; }
        function loadEffect() { assets.effect.img.src = document.getElementById('effectSelect').value; assets.effect.img.onload = drawCard; }
        function sync(val, targetId) { document.getElementById(targetId).value = val; if(targetId.startsWith('n_')) document.getElementById(targetId.substring(2)).value=val; drawCard(); }

        function drawTintedImage(img, color, isEnabled) {
            if (!isEnabled) { ctx.drawImage(img, 0, 0, CW, CH); return; }
            const tCv = document.createElement('canvas'); tCv.width = CW; tCv.height = CH; const tCtx = tCv.getContext('2d');
            tCtx.drawImage(img, 0, 0, CW, CH);
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.fillStyle = color;
            tCtx.fillRect(0, 0, CW, CH);
            ctx.drawImage(tCv, 0, 0, CW, CH);
        }

        function drawCard() {
            ctx.clearRect(0, 0, CW, CH);
            ctx.fillStyle = document.getElementById('paperColor').value; ctx.fillRect(0, 0, CW, CH);

            if (assets.user.loaded) {
                const s = parseFloat(document.getElementById('userScale').value);
                const w = assets.user.img.width * s, h = assets.user.img.height * s;
                ctx.drawImage(assets.user.img, parseFloat(document.getElementById('userX').value) - w/2, parseFloat(document.getElementById('userY').value) - h/2, w, h);
            }

            if (assets.mask.img.complete) drawTintedImage(assets.mask.img, document.getElementById('tintColorB').value, document.getElementById('tintEnableB').checked);
            if (assets.texture.img.complete) drawTintedImage(assets.texture.img, document.getElementById('tintColorC').value, document.getElementById('tintEnableC').checked);
            if (assets.deco.img.complete) drawTintedImage(assets.deco.img, document.getElementById('tintColorD').value, document.getElementById('tintEnableD').checked);
            if (assets.base.img.complete) { ctx.save(); ctx.globalCompositeOperation = 'multiply'; ctx.drawImage(assets.base.img, 0, 0, CW, CH); ctx.restore(); }

            if (assets.effect.img.complete) {
                ctx.save();
                ctx.globalAlpha = document.getElementById('effectOpacity').value;
                ctx.globalCompositeOperation = document.getElementById('effectBlend').value;
                ctx.drawImage(assets.effect.img, 0, 0, CW, CH);
                ctx.restore();
            }

            const font = document.getElementById('fontSelect').value;
            ctx.fillStyle = document.getElementById('textColor').value;
            ctx.textAlign = "center";
            ctx.font = `bold 42px ${font}`;
            ctx.fillText(document.getElementById('cardName').value, 325, parseFloat(document.getElementById('n_titleY').value));
            ctx.font = `bold 32px ${font}`;
            ctx.fillText(document.getElementById('cardRace').value, parseFloat(document.getElementById('n_raceX').value), parseFloat(document.getElementById('n_raceY').value));

            if (assets.rank.img.complete) ctx.drawImage(assets.rank.img, 0, 0, CW, CH);

            ctx.textAlign = "left"; ctx.font = `26px ${font}`;
            wrapText(document.getElementById('cardDesc').value, 85, 700, 480, 38);
        }

        function wrapText(text, x, y, maxW, lineH) {
            let words = text.split(''); let line = '';
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n];
                if (ctx.measureText(testLine).width > maxW) { ctx.fillText(line, x, y); line = words[n]; y += lineH; } else { line = testLine; }
            } ctx.fillText(line, x, y);
        }
        
        function downloadCard() { const a = document.createElement('a'); a.download = document.getElementById('cardName').value + ".png"; a.href = canvas.toDataURL(); a.click(); }
        window.onload = preloadAssets;
    </script>
</body>
</html>

